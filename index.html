<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern WYSIWYG HTML Editor</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>
    
    <style>
        /*
         * =============================================
         * ===  1. DESIGN SYSTEM & BASE STYLES       ===
         * =============================================
         * A fresh, modern, and softer design system.
        */
        :root {
            /* Color Palette */
            --blue-500: #007aff;
            --blue-600: #005ecb;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-400: #9ca3af;
            --gray-700: #374151;
            --gray-900: #111827;
            
            /* Primary Theme Colors */
            --primary-color: var(--blue-500);
            --primary-color-hover: var(--blue-600);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-700);
            --bg-body: var(--gray-100);
            --bg-panel: #ffffff;
            --border-color: var(--gray-200);
            
            /* Sizing & Spacing */
            --spacing-xs: 0.25rem; /* 4px */
            --spacing-sm: 0.5rem;  /* 8px */
            --spacing-md: 1rem;    /* 16px */
            --spacing-lg: 1.5rem;  /* 24px */
            --border-radius: 6px;
            
            /* Fonts */
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            --font-family-mono: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace;
        }

        /* Base Body Styles */
        body {
            font-family: var(--font-family-sans);
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll on desktop */
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Screen-reader only utility */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; 
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }


        /*
         * =============================================
         * ===  2. LAYOUT & CORE COMPONENTS          ===
         * =============================================
         * Global header, main container, and panels.
        */

        /* Global Header for Universal Toolbar */
        .app-header {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
        }

        /* Main App Container (Flexbox) */
        .app-main {
            flex-grow: 1;
            display: flex;
            padding: var(--spacing-md);
            gap: var(--spacing-md);
            min-height: 0; /* Critical for flex children to shrink */
            /* Mobile-first: default to column layout */
            flex-direction: column;
        }

        /* Panel Styling */
        .panel {
            display: flex;
            flex-direction: column;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.04);
            padding: var(--spacing-lg);
            overflow: hidden;
            flex-shrink: 0; /* Prevent panels from shrinking unexpectedly */
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 var(--spacing-md) 0;
            text-align: center;
            color: var(--primary-color);
        }

        /*
         * =============================================
         * ===  3. UNIVERSAL TOOLBAR                 ===
         * =============================================
         * A refined, lighter toolbar design.
        */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            justify-content: center;
            align-items: center;
        }

        .toolbar-button {
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 1rem;
            line-height: 1.5;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        }

        .toolbar-button:hover {
            background-color: var(--gray-100);
            border-color: var(--gray-400);
            color: var(--text-primary);
        }

        .toolbar-button.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .toolbar-select {
            padding: calc(var(--spacing-xs) + 2px) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
            font-size: 0.9rem;
            cursor: pointer;
            outline-offset: 2px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .toolbar-select:focus {
            outline: 2px solid var(--primary-color);
            border-color: var(--primary-color);
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        .color-picker-group label { font-size: 0.9rem; color: var(--text-secondary); }
        .color-picker { width: 20px; height: 20px; border: 1px solid var(--border-color); padding: 0; border-radius: 4px; cursor: pointer; background-color: transparent; }

        /*
         * =============================================
         * ===  4. MOBILE VIEW TOGGLE                ===
         * =============================================
         * Clean, segmented control for mobile.
        */
        .mobile-view-toggle {
            display: flex;
            padding: 0 var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .mobile-view-toggle .toggle-btn {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 1rem;
            font-weight: 500;
            border: 1px solid var(--primary-color);
            background-color: #fff;
            color: var(--primary-color);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .mobile-view-toggle .toggle-btn:first-child {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        
        .mobile-view-toggle .toggle-btn:last-child {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            border-left-width: 0;
        }

        .mobile-view-toggle .toggle-btn.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        /*
         * =============================================
         * ===  5. PANEL-SPECIFIC STYLES             ===
         * =============================================
        */
        
        /* Code Editor Panel */
        .code-editor-panel.drag-over {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-color);
        }
        .code-textarea {
            flex-grow: 1;
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: var(--font-family-mono);
            font-size: 0.9rem;
            resize: none;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .code-textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.25);
        }
        .panel-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        .action-button {
            flex: 1 1 auto;
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: background-color 0.2s;
        }
        .action-button.primary { background-color: var(--primary-color); color: white; }
        .action-button.primary:hover { background-color: var(--primary-color-hover); }

        /* Preview Panel */
        .editable-frame {
            flex-grow: 1;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
        }

        /* Split.js Gutter */
        .gutter { background-color: transparent; }
        .gutter.gutter-horizontal { cursor: ew-resize; }

        /*
         * =============================================
         * ===  6. MODALS & OVERLAYS                 ===
         * =============================================
        */
        .message-box {
            position: fixed; bottom: var(--spacing-md); left: 50%;
            transform: translate(-50%, 100px);
            background-color: var(--gray-900); color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0; visibility: hidden;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 1000;
        }
        .message-box.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--bg-panel); padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 450px; position: relative;
            display: flex; flex-direction: column; gap: var(--spacing-md);
        }
        .modal-content h3 { margin: 0; font-size: 1.2rem; color: var(--text-primary); }
        .modal-close-btn {
            position: absolute; top: var(--spacing-sm); right: var(--spacing-sm);
            background: none; border: none; font-size: 1.5rem; color: var(--gray-400);
            cursor: pointer; transition: color 0.2s;
        }
        .modal-close-btn:hover { color: var(--text-primary); }
        .modal-input {
            width: 100%; padding: var(--spacing-sm);
            border: 1px solid var(--border-color); border-radius: var(--border-radius);
            font-size: 1rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .modal-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.25);
        }
        .modal-button {
            align-self: flex-end; padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--primary-color); color: white;
            border: none; border-radius: var(--border-radius); font-size: 1rem;
            cursor: pointer; transition: background-color 0.2s;
        }
        .modal-button:hover { background-color: var(--primary-color-hover); }

        /*
         * =============================================
         * ===  7. RESPONSIVE DESKTOP LAYOUT         ===
         * =============================================
         * Media query to switch to the split-pane view.
        */
        @media (min-width: 1024px) {
            body {
                overflow: hidden; /* Re-hide overflow for desktop */
            }
            .mobile-view-toggle {
                display: none; /* Hide toggle on desktop */
            }
            .app-main {
                flex-direction: row; /* Switch to side-by-side */
            }
            .panel {
                flex-grow: 1;
                /* Overwrite potential inline styles from mobile logic */
                display: flex !important;
            }
        }
    </style>
</head>
<body>

    <!-- Universal Toolbar -->
    <header class="app-header">
        <div id="editorToolbar" class="editor-toolbar">
            <button class="toolbar-button" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
            <button class="toolbar-button" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
            <button class="toolbar-button" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
            <button class="toolbar-button" data-command="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
            <button class="toolbar-button" data-command="insertUnorderedList" title="Bulleted List"><i class="fas fa-list-ul"></i></button>
            <button class="toolbar-button" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
            
            <div class="color-picker-group">
                <label for="fontColorPicker"><i class="fas fa-palette"></i></label>
                <input type="color" id="fontColorPicker" class="color-picker" title="Font Color">
            </div>
            <div class="color-picker-group">
                <label for="fontBgColorPicker"><i class="fas fa-highlighter"></i></label>
                <input type="color" id="fontBgColorPicker" class="color-picker" title="Highlight Color">
            </div>

            <button class="toolbar-button" id="insertLinkBtn" title="Insert Link"><i class="fas fa-link"></i></button>
            <button class="toolbar-button" id="insertImageBtn" title="Insert Image"><i class="fas fa-image"></i></button>
            <button class="toolbar-button" data-command="removeFormat" title="Clear Formatting"><i class="fas fa-eraser"></i></button>

            <select id="fontSelect" class="toolbar-select" title="Font Family">
                <option value="" disabled selected>Font Family</option>
            </select>
        </div>
    </header>

    <!-- Mobile View Toggle Controls -->
    <div class="mobile-view-toggle" id="mobileViewToggle">
        <button class="toggle-btn active" data-view="code">Code</button>
        <button class="toggle-btn" data-view="preview">Preview</button>
    </div>

    <!-- Main Content Area (Code and Preview Panels) -->
    <main class="app-main" id="appContainer">
        <section id="code-panel" class="panel code-editor-panel">
            <h2 class="panel-title">HTML Source</h2>
            <textarea id="htmlCode" class="code-textarea" placeholder="Paste your HTML here, or drop an .html file..."></textarea>
            <div class="panel-actions">
                <input type="file" id="htmlFileInput" accept=".html,.htm" class="sr-only">
                <button id="uploadHtmlButton" class="action-button primary"><i class="fas fa-upload"></i> Upload</button>
                <button id="syncButton" class="action-button primary"><i class="fas fa-sync-alt"></i> Sync</button>
                <button id="downloadButton" class="action-button primary"><i class="fas fa-download"></i> Download</button>
            </div>
        </section>

        <section id="preview-panel" class="panel preview-panel">
            <h2 class="panel-title">Live Preview</h2>
            <iframe id="previewFrame" class="editable-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups"></iframe>
        </section>
    </main>
    
    <!-- Overlays -->
    <div id="messageBox" class="message-box"></div>

    <div id="linkModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close">×</button>
            <h3>Insert Link</h3>
            <label for="linkURL">URL:</label>
            <input type="url" id="linkURL" placeholder="https://example.com" class="modal-input">
            <button id="confirmLinkBtn" class="modal-button">Insert</button>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close">×</button>
            <h3>Insert Image</h3>
            <label for="imageURL">Image URL:</label>
            <input type="url" id="imageURL" placeholder="https://example.com/image.jpg" class="modal-input">
            <button id="confirmImageBtn" class="modal-button">Insert</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const getEl = (id) => document.getElementById(id);
        const htmlCodeTextArea = getEl('htmlCode');
        const previewFrame = getEl('previewFrame');
        const syncButton = getEl('syncButton');
        const downloadButton = getEl('downloadButton');
        const editorToolbar = getEl('editorToolbar');
        const uploadHtmlButton = getEl('uploadHtmlButton');
        const htmlFileInput = getEl('htmlFileInput');
        const codePanel = getEl('code-panel');
        const previewPanel = getEl('preview-panel');
        const mobileViewToggle = getEl('mobileViewToggle');
        const fontColorPicker = getEl('fontColorPicker');
        const fontBgColorPicker = getEl('fontBgColorPicker');
        const fontSelect = getEl('fontSelect');
        const messageBox = getEl('messageBox');
        
        // Modals
        const linkModal = getEl('linkModal');
        const imageModal = getEl('imageModal');

        // --- State Variables ---
        let iframeDoc;
        let activeEditor = 'code'; // 'code' or 'preview'
        let currentRange = null; // For restoring selection in modals
        let splitInstance = null;
        const RESPONSIVE_BREAKPOINT = 1024;

        // --- Utility Functions ---
        const showMessage = (message, duration = 3000) => {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        };
        
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };
        const syncFromPreviewDebounced = debounce(syncFromPreview, 400);

        // --- Core Editor Logic ---
        const updatePreview = () => {
            try {
                const htmlContent = htmlCodeTextArea.value;
                iframeDoc = previewFrame.contentWindow.document;
                
                const googleFonts = ["Roboto", "Open Sans", "Lato", "Montserrat", "Poppins", "Merriweather", "Playfair Display"];
                const fontFamiliesParam = googleFonts.map(font => `family=${encodeURIComponent(font).replace(/%20/g, '+')}`).join('&');
                const googleFontsLink = `https://fonts.googleapis.com/css2?${fontFamiliesParam}&display=swap`;

                const iframeHTML = `<!DOCTYPE html>
                <html><head>
                    <link href="${googleFontsLink}" rel="stylesheet">
                    <style>
                        body { margin: 1rem; font-family: 'Roboto', sans-serif; line-height: 1.6; word-wrap: break-word; outline: none; }
                        img { max-width: 100%; height: auto; display: block; margin: 0.5rem 0; cursor: pointer; }
                        a { color: #007aff; }
                        blockquote { border-left: 3px solid #e5e7eb; padding-left: 1rem; margin-left: 0; font-style: italic; }
                    </style>
                </head><body>${htmlContent}</body></html>`;
                
                iframeDoc.open();
                iframeDoc.write(iframeHTML);
                iframeDoc.close();
                iframeDoc.designMode = 'on';

                // Attach listeners to the new iframe document
                iframeDoc.body.addEventListener('input', () => { syncFromPreviewDebounced(); updateToolbarState(); });
                iframeDoc.addEventListener('selectionchange', updateToolbarState);
                iframeDoc.addEventListener('focus', () => { activeEditor = 'preview'; }, true);
                
            } catch (error) {
                console.error('Error rendering HTML:', error);
                showMessage('Error rendering HTML. Check console.', 5000);
            }
        };

        const syncFromPreview = () => {
            if (!iframeDoc) return;
            // A simple prettify to avoid one long line of code
            htmlCodeTextArea.value = iframeDoc.body.innerHTML
                .replace(/</g, '\n<')
                .replace(/>/g, '>\n')
                .replace(/^\s*\n/gm, '')
                .replace(/\n\s*\n/g, '\n');
            showMessage('Synced from Preview', 2000);
        };
        
        const downloadHtml = () => {
            try {
                const blob = new Blob([htmlCodeTextArea.value], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'edited-page.html';
                a.click();
                URL.revokeObjectURL(a.href);
                showMessage('Download started!', 3000);
            } catch (error) {
                console.error('Error downloading HTML:', error);
                showMessage('Download failed.', 5000);
            }
        };
        
        // --- Universal Command Execution ---
        const executeCommand = (command, value = null) => {
            if (activeEditor === 'preview') {
                if (!iframeDoc) { showMessage('Preview not rendered', 3000); return; }
                previewFrame.contentWindow.focus();
                iframeDoc.execCommand(command, false, value);
                syncFromPreviewDebounced();
                updateToolbarState();
            } else if (activeEditor === 'code') {
                applyTagToTextarea(command);
            }
        };
        
        const applyTagToTextarea = (command) => {
            const tagMap = { 'bold': 'strong', 'italic': 'em', 'underline': 'u', 'strikeThrough': 's' };
            const tag = tagMap[command];
            if (!tag) {
                showMessage(`Command '${command}' not supported for code editor.`, 2000);
                return;
            }
            const start = htmlCodeTextArea.selectionStart;
            const end = htmlCodeTextArea.selectionEnd;
            if (start === end) { showMessage('Select text in the code editor first.', 2500); return; }
            const selectedText = htmlCodeTextArea.value.substring(start, end);
            const newText = `<${tag}>${selectedText}</${tag}>`;
            htmlCodeTextArea.value = `${htmlCodeTextArea.value.substring(0, start)}${newText}${htmlCodeTextArea.value.substring(end)}`;
            htmlCodeTextArea.focus();
            htmlCodeTextArea.setSelectionRange(start + newText.length, start + newText.length);
            debounce(updatePreview, 500)();
        };

        const updateToolbarState = () => {
            if (!iframeDoc || activeEditor !== 'preview') return;
            const commands = ['bold', 'italic', 'underline', 'strikeThrough', 'insertUnorderedList', 'insertOrderedList'];
            commands.forEach(command => {
                const button = editorToolbar.querySelector(`[data-command="${command}"]`);
                if (button) {
                    try {
                        button.classList.toggle('active', iframeDoc.queryCommandState(command));
                    } catch (e) { button.classList.remove('active'); }
                }
            });
        };

        // --- File Handling ---
        const handleFile = (file) => {
            if (!file || !file.type.match('text/html')) {
                showMessage('Invalid file. Please select an .html file.', 4000);
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                htmlCodeTextArea.value = e.target.result;
                showMessage(`${file.name} loaded successfully.`, 2500);
                updatePreview();
            };
            reader.onerror = () => showMessage(`Error reading file: ${file.name}`, 4000);
            reader.readAsText(file);
        };

        // --- Responsive Layout Engine ---
        const handleLayoutChange = () => {
            const isDesktop = window.innerWidth >= RESPONSIVE_BREAKPOINT;
            if (isDesktop) {
                mobileViewToggle.style.display = 'none';
                codePanel.style.display = 'flex';
                previewPanel.style.display = 'flex';
                if (!splitInstance) {
                    splitInstance = Split(['#code-panel', '#preview-panel'], {
                        sizes: [50, 50], minSize: 300, gutterSize: 16, direction: 'horizontal'
                    });
                }
            } else {
                mobileViewToggle.style.display = 'flex';
                if (splitInstance) {
                    splitInstance.destroy();
                    splitInstance = null;
                }
                const activeView = mobileViewToggle.querySelector('.toggle-btn.active').dataset.view;
                codePanel.style.display = activeView === 'code' ? 'flex' : 'none';
                previewPanel.style.display = activeView === 'preview' ? 'flex' : 'none';
            }
        };
        
        // --- Modal Management ---
        const setupModals = () => {
            const openModal = (modal, onOpen) => {
                modal.classList.add('show');
                if (activeEditor === 'preview' && iframeDoc?.getSelection()?.rangeCount > 0) {
                    currentRange = iframeDoc.getSelection().getRangeAt(0);
                }
                if (onOpen) onOpen();
            };
            const closeModal = (modal) => {
                modal.classList.remove('show');
                modal.querySelectorAll('input').forEach(input => input.value = '');
                currentRange = null;
            };

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal || e.target.closest('.modal-close-btn')) {
                        closeModal(modal);
                    }
                });
            });

            getEl('insertLinkBtn').addEventListener('click', () => openModal(linkModal, () => getEl('linkURL').focus()));
            getEl('insertImageBtn').addEventListener('click', () => openModal(imageModal, () => getEl('imageURL').focus()));

            getEl('confirmLinkBtn').addEventListener('click', () => {
                const url = getEl('linkURL').value;
                if (!url) { showMessage('Please enter a URL.', 2000); return; }
                if (currentRange) iframeDoc.getSelection().addRange(currentRange);
                executeCommand('createLink', url);
                closeModal(linkModal);
            });
            getEl('confirmImageBtn').addEventListener('click', () => {
                const url = getEl('imageURL').value;
                if (!url) { showMessage('Please enter an image URL.', 2000); return; }
                if (currentRange) iframeDoc.getSelection().addRange(currentRange);
                executeCommand('insertImage', url);
                closeModal(imageModal);
            });
        };

        // --- Event Listener Setup ---
        const addEventListeners = () => {
            syncButton.addEventListener('click', syncFromPreview);
            downloadButton.addEventListener('click', downloadHtml);
            htmlCodeTextArea.addEventListener('focus', () => { activeEditor = 'code'; });

            // Universal Toolbar
            editorToolbar.addEventListener('click', (e) => {
                const target = e.target.closest('button[data-command]');
                if (target) executeCommand(target.dataset.command);
            });
            fontColorPicker.addEventListener('input', (e) => executeCommand('foreColor', e.target.value));
            fontBgColorPicker.addEventListener('input', (e) => executeCommand('backColor', e.target.value));
            fontSelect.addEventListener('change', (e) => executeCommand('fontName', e.target.value));

            // File Handling
            uploadHtmlButton.addEventListener('click', () => htmlFileInput.click());
            htmlFileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            codePanel.addEventListener('dragover', (e) => { e.preventDefault(); codePanel.classList.add('drag-over'); });
            codePanel.addEventListener('dragleave', () => codePanel.classList.remove('drag-over'));
            codePanel.addEventListener('drop', (e) => { e.preventDefault(); codePanel.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });

            // Mobile Toggle
            mobileViewToggle.addEventListener('click', (e) => {
                const target = e.target.closest('.toggle-btn');
                if (!target || target.classList.contains('active')) return;
                
                mobileViewToggle.querySelector('.active').classList.remove('active');
                target.classList.add('active');
                handleLayoutChange(); // Re-evaluate layout after toggle
            });

            window.addEventListener('resize', debounce(handleLayoutChange, 250));
        };

        // --- Initialization ---
        const init = () => {
            const initialContent = `<h1>Welcome to the Editor!</h1>\n<p>This is a <strong>powerful</strong> and <em>intuitive</em> editor. Try editing this text.</p>\n<ul>\n    <li>Modern & clean UI</li>\n    <li>Works on mobile & desktop</li>\n</ul>\n<p>You can also insert <a href="https://example.com" target="_blank">links</a> and <span style="background-color: #fef08a;">highlighted text</span>.</p>\n<img src="https://placehold.co/600x300/a7f3d0/4b5563?text=Editable+Image" alt="Placeholder Image">`;
            htmlCodeTextArea.value = initialContent;
            
            const fonts = ["Roboto", "Open Sans", "Lato", "Montserrat", "Poppins", "Merriweather", "Playfair Display", "Arial", "Georgia", "Verdana"];
            fonts.sort().forEach(font => fontSelect.add(new Option(font, font)));

            addEventListeners();
            setupModals();
            updatePreview();
            handleLayoutChange(); // Set initial layout
            
            showMessage('Editor loaded successfully!', 2500);
        };

        init();
    });
    </script>
</body>
</html>
