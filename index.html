<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Editor - Advanced WYSIWYG & Code</title>
    <!-- Google Fonts: Inter for UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Split.js for Resizable Panels -->
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>
    
    <!-- CodeMirror 6 Dependencies -->
    <script src="https://unpkg.com/@codemirror/state@6.2.1/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@codemirror/view@6.16.0/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@codemirror/commands@6.2.4/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@codemirror/language@6.8.0/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@codemirror/lang-html@6.4.5/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@codemirror/autocomplete@6.8.1/dist/index.umd.js"></script>
    
    <style>
        /* Variables for consistent styling */
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #8C6FF7;
            --tertiary-color: #2ECC71;
            --danger-color: #E74C3C;
            --text-color: #333;
            --text-light: #666;
            --bg-light: #F4F7F6;
            --bg-panel: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --spacing-unit: 1rem;
            --font-family-body: 'Inter', sans-serif;
        }

        /* Base Styles */
        body {
            font-family: var(--font-family-body);
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-light);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* NEW: Main Application Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem var(--spacing-unit);
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        .app-header .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        .app-header .logo .fa-atom {
            margin-right: 0.5rem;
        }
        .app-header .project-info {
            text-align: center;
        }
        #current-project-name {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
        }
        .header-button {
             padding: 0.6rem 1rem;
             border: 1px solid var(--border-color);
             border-radius: calc(var(--border-radius) / 2);
             font-size: 0.9rem;
             font-weight: 500;
             cursor: pointer;
             transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
             background-color: white;
        }
        .header-button:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2);
        }
        .header-button i { margin-right: 0.5rem; }

        #app-container {
            flex: 1;
            display: flex;
            padding: var(--spacing-unit);
            gap: 0;
            min-height: 0;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background-color: var(--bg-panel);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            padding: calc(var(--spacing-unit) * 1.5);
            overflow: hidden;
        }
        .panel-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--spacing-unit);
            text-align: center;
            color: var(--primary-color);
        }

        /* Code Editor Panel Styling */
        .code-editor-panel {
            /* NEW: Remove padding to allow CodeMirror to fill the space */
            padding: 0;
        }
        .code-editor-panel .panel-title {
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 1.5) 0;
            margin-bottom: var(--spacing-unit);
        }
        /* NEW: Container for CodeMirror instance */
        #code-editor-container {
            flex: 1;
            overflow: hidden; /* CM handles its own scroll */
            position: relative; /* For CM child elements */
        }
        /* NEW: CodeMirror styling to ensure it fits the container */
        .cm-editor {
            height: 100%;
            font-size: 0.95rem;
        }
        .panel-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            padding: var(--spacing-unit);
            border-top: 1px solid var(--border-color);
            background-color: #fafafa;
        }

        .action-button {
            padding: 0.75rem 1.25rem; border: none; border-radius: calc(var(--border-radius) / 2);
            font-size: 1rem; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            display: inline-flex; align-items: center; gap: 0.5rem; flex: 1 1 auto;
            min-width: 140px; justify-content: center;
        }
        .action-button i { font-size: 1.1em; }
        .action-button.primary { background-color: var(--primary-color); color: white; }
        .action-button.primary:hover { background-color: #3A7CD0; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3); }
        .action-button.secondary { background-color: var(--secondary-color); color: white; }
        .action-button.secondary:hover { background-color: #7258D6; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(140, 111, 247, 0.3); }
        .action-button.tertiary { background-color: var(--tertiary-color); color: white; }
        .action-button.tertiary:hover { background-color: #27AE60; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3); }
        
        /* Gutter Styles (unchanged) */
        .gutter { background-color: var(--border-color); background-repeat: no-repeat; background-position: 50%; border-radius: var(--border-radius); transition: background-color 0.2s ease; }
        .gutter:hover { background-color: var(--primary-color); }
        .gutter.gutter-horizontal { cursor: ew-resize; margin: 0 var(--spacing-unit); }
        .gutter.gutter-vertical { cursor: ns-resize; margin: var(--spacing-unit) 0; }
        
        /* Preview Panel (mostly unchanged) */
        .preview-panel { position: relative; overflow: hidden; }
        .editor-toolbar { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); margin-bottom: var(--spacing-unit); justify-content: center; align-items: center; }
        .toolbar-button { background-color: transparent; border: 1px solid var(--border-color); border-radius: 4px; padding: 0.6rem 0.8rem; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; color: var(--text-color); }
        .toolbar-button:hover, .toolbar-button:focus, .toolbar-button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); outline: none; }
        .color-picker-container { display: flex; align-items: center; gap: 0.3rem; position: relative; padding: 0.3rem 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; }
        .color-picker-container .color-label { font-size: 0.9rem; white-space: nowrap; }
        .color-picker { width: 24px; height: 24px; background-color: transparent; border: none; cursor: pointer; padding: 0; }
        .toolbar-select { padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: white; font-size: 0.9rem; cursor: pointer; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        .toolbar-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); }
        .editable-frame { flex: 1; width: 100%; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: white; min-height: 200px; }
        
        /* Message Box & Modals (mostly unchanged) */
        .message-box { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 0.75rem 1.5rem; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 2000; white-space: nowrap; }
        .message-box.show { opacity: 1; visibility: visible; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--bg-panel); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-light); width: 90%; max-width: 600px; position: relative; display: flex; flex-direction: column; gap: 1.5rem; max-height: 80vh; }
        .modal-content h3 { margin-top: 0; font-size: 1.5rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .close-button { position: absolute; top: 1rem; right: 1rem; font-size: 1.8rem; cursor: pointer; color: #888; transition: color 0.2s; }
        .close-button:hover { color: var(--text-color); }
        .modal-input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; }
        .modal-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2); }
        .modal-button { align-self: flex-end; padding: 0.75rem 1.5rem; border: none; border-radius: calc(var(--border-radius) / 2); font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .modal-button.primary { background-color: var(--primary-color); color: white; }
        .modal-button.primary:hover { background-color: #3A7CD0; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3); }

        /* NEW: Project Modal Specific Styles */
        .project-modal-section { margin-bottom: 1rem; }
        .project-modal-section h4 { font-size: 1.1rem; margin-top: 0; margin-bottom: 0.75rem; color: var(--text-light); }
        .save-project-form { display: flex; gap: 0.75rem; }
        #project-name-input { flex-grow: 1; }
        .project-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; max-height: 250px; border: 1px solid var(--border-color); border-radius: 4px; }
        .project-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); }
        .project-item:last-child { border-bottom: none; }
        .project-item-info { display: flex; flex-direction: column; }
        .project-item-name { font-weight: 500; }
        .project-item-date { font-size: 0.8rem; color: var(--text-light); }
        .project-item-actions button { background: none; border: 1px solid transparent; padding: 0.4rem 0.6rem; margin-left: 0.5rem; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .project-item-actions .load-btn:hover { background-color: var(--tertiary-color); color: white; border-color: var(--tertiary-color); }
        .project-item-actions .delete-btn:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); }
        .new-project-button { background-color: var(--secondary-color); color: white; width: 100%; }
        .new-project-button:hover { background-color: #7258D6; }
    </style>
</head>
<body>
    <!-- NEW: Main Application Header -->
    <header class="app-header">
        <div class="logo"><i class="fas fa-atom"></i>Nexus Editor</div>
        <div class="project-info">
            <h1 id="current-project-name" class="sr-only">Current Project</h1>
        </div>
        <button id="projects-button" class="header-button"><i class="fas fa-folder-open"></i> Projects</button>
    </header>

    <div id="app-container">
        <!-- Code Editor Panel -->
        <div id="code-panel" class="panel code-editor-panel">
            <h2 class="panel-title">HTML Source Code</h2>
            <!-- NEW: CodeMirror will be attached here instead of the textarea -->
            <div id="code-editor-container"></div>
            <div class="panel-actions">
                <button id="renderButton" class="action-button primary">
                    <i class="fas fa-play"></i> Update Preview
                </button>
                <button id="syncButton" class="action-button secondary">
                    <i class="fas fa-sync-alt"></i> Sync from Preview
                </button>
                <button id="downloadButton" class="action-button tertiary">
                    <i class="fas fa-download"></i> Download HTML
                </button>
            </div>
        </div>

        <!-- Live Preview Panel (unchanged from original) -->
        <div id="preview-panel" class="panel preview-panel">
            <h2 class="panel-title">Live Preview (Editable)</h2>
            <div id="editorToolbar" class="editor-toolbar">
                <button class="toolbar-button" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
                <button class="toolbar-button" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
                <button class="toolbar-button" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
                <button class="toolbar-button" data-command="strikeThrough" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                <button class="toolbar-button" data-command="insertUnorderedList" title="Bulleted List"><i class="fas fa-list-ul"></i></button>
                <button class="toolbar-button" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                <div class="color-picker-container">
                    <label for="fontColorPicker" class="sr-only">Font Color</label>
                    <input type="color" id="fontColorPicker" class="color-picker" title="Font Color" value="#000000">
                </div>
                <button class="toolbar-button" id="insertLinkBtn" title="Insert Link"><i class="fas fa-link"></i></button>
                <button class="toolbar-button" id="insertImageBtn" title="Insert Image"><i class="fas fa-image"></i></button>
                <button class="toolbar-button" id="clearFormatBtn" title="Clear Formatting"><i class="fas fa-eraser"></i></button>
                <select id="fontSelect" class="toolbar-select" title="Font Family"><option value="" disabled selected>Font Family</option></select>
            </div>
            <iframe id="previewFrame" class="editable-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups"></iframe>
            <div id="messageBox" class="message-box"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="linkModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span><h3>Insert Hyperlink</h3>
            <input type="url" id="linkURL" placeholder="https://example.com" class="modal-input" aria-label="URL"><button id="confirmLinkBtn" class="modal-button primary">Insert</button>
        </div>
    </div>
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span><h3>Insert Image</h3>
            <input type="url" id="imageURL" placeholder="https://example.com/image.jpg" class="modal-input" aria-label="Image URL"><button id="confirmImageBtn" class="modal-button primary">Insert</button>
        </div>
    </div>

    <!-- NEW: Project Management Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <h3>Manage Projects</h3>
            
            <div class="project-modal-section">
                <h4>Save Current Project</h4>
                <div class="save-project-form">
                    <input type="text" id="project-name-input" class="modal-input" placeholder="Enter project name...">
                    <button id="save-project-button" class="modal-button primary">Save</button>
                </div>
            </div>

            <div class="project-modal-section">
                <h4>Load Project</h4>
                <ul id="project-list">
                    <!-- Project items will be dynamically inserted here -->
                </ul>
            </div>
            
            <div class="project-modal-section">
                <button id="new-project-button" class="modal-button new-project-button"><i class="fas fa-plus-circle"></i> Create New Blank Project</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CodeMirror Namespace ---
        const { EditorState } = codemirror.state;
        const { EditorView, keymap, lineNumbers } = codemirror.view;
        const { defaultKeymap, indentWithTab } = codemirror.commands;
        const { html } = codemirror.lang_html;
        const { autocompletion } = codemirror.autocomplete;

        // --- DOM Element References ---
        const previewFrame = document.getElementById('previewFrame');
        const renderButton = document.getElementById('renderButton');
        const syncButton = document.getElementById('syncButton');
        const downloadButton = document.getElementById('downloadButton');
        const messageBox = document.getElementById('messageBox');
        const editorToolbar = document.getElementById('editorToolbar');
        const fontSelect = document.getElementById('fontSelect');
        const appContainer = document.getElementById('app-container');
        const currentProjectNameDisplay = document.getElementById('current-project-name');
        
        // Modals & Project Management UI
        const linkModal = document.getElementById('linkModal');
        const imageModal = document.getElementById('imageModal');
        const projectModal = document.getElementById('projectModal');
        const projectsButton = document.getElementById('projects-button');
        const projectNameInput = document.getElementById('project-name-input');
        const saveProjectButton = document.getElementById('save-project-button');
        const projectList = document.getElementById('project-list');
        const newProjectButton = document.getElementById('new-project-button');
        
        // --- State Management ---
        const STORAGE_KEYS = {
            ACTIVE_SESSION: 'nexus-active-session',
            PROJECTS: 'nexus-projects'
        };
        const DEFAULT_HTML = `<h1>Welcome to Nexus Editor!</h1>\n<p>Start creating something amazing. Your work is auto-saved.</p>`;
        let activeSession = {
            id: null,
            name: 'Untitled Project',
            html: DEFAULT_HTML
        };
        let codeEditor; // CodeMirror instance
        let iframeDoc;
        let currentRange = null;

        // --- Utility Functions ---
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => func.apply(this, args), delay); };
        };

        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => { messageBox.classList.remove('show'); }, duration);
        }

        // --- Session & Project Management ---
        const saveActiveSession = debounce(() => {
            try {
                localStorage.setItem(STORAGE_KEYS.ACTIVE_SESSION, JSON.stringify(activeSession));
                console.log('Session auto-saved.');
            } catch (e) {
                console.error("Error saving session to localStorage:", e);
                showMessage("Could not save session. Storage might be full.", 4000);
            }
        }, 1000);
        
        function updateProjectNameUI() {
            const name = activeSession.name || 'Untitled Project';
            currentProjectNameDisplay.textContent = name;
            // Update modal input as well for convenience
            projectNameInput.value = name !== 'Untitled Project' ? name : '';
        }
        
        function loadProject(projectId) {
            const projects = JSON.parse(localStorage.getItem(STORAGE_KEYS.PROJECTS) || '[]');
            const projectToLoad = projects.find(p => p.id === projectId);
            if (projectToLoad) {
                activeSession = { ...projectToLoad };
                codeEditor.dispatch({
                    changes: { from: 0, to: codeEditor.state.doc.length, insert: activeSession.html }
                });
                updateProjectNameUI();
                saveActiveSession();
                updatePreview();
                closeModal(projectModal);
                showMessage(`Project "${activeSession.name}" loaded.`, 2000);
            }
        }

        function saveProject() {
            const projectName = projectNameInput.value.trim();
            if (!projectName) {
                showMessage("Please enter a project name.", 3000);
                return;
            }

            let projects = JSON.parse(localStorage.getItem(STORAGE_KEYS.PROJECTS) || '[]');
            activeSession.name = projectName;
            activeSession.html = codeEditor.state.doc.toString();

            if (activeSession.id) { // Existing project
                const projectIndex = projects.findIndex(p => p.id === activeSession.id);
                if (projectIndex > -1) {
                    projects[projectIndex] = { ...activeSession, lastModified: new Date().toISOString() };
                }
            } else { // New project
                activeSession.id = Date.now();
                projects.push({ ...activeSession, lastModified: new Date().toISOString() });
            }

            localStorage.setItem(STORAGE_KEYS.PROJECTS, JSON.stringify(projects));
            saveActiveSession(); // Also update the active session store
            updateProjectNameUI();
            showMessage(`Project "${projectName}" saved!`, 2000);
            closeModal(projectModal);
        }
        
        function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) return;

            let projects = JSON.parse(localStorage.getItem(STORAGE_KEYS.PROJECTS) || '[]');
            projects = projects.filter(p => p.id !== projectId);
            localStorage.setItem(STORAGE_KEYS.PROJECTS, JSON.stringify(projects));

            if (activeSession.id === projectId) {
                // If deleting the active project, start a new one
                createNewProject(false);
            }
            renderProjectList();
            showMessage("Project deleted.", 2000);
        }
        
        function createNewProject(closeModalAfter = true) {
            activeSession = { id: null, name: 'Untitled Project', html: '<h1>New Blank Project</h1>' };
            codeEditor.dispatch({
                changes: { from: 0, to: codeEditor.state.doc.length, insert: activeSession.html }
            });
            updateProjectNameUI();
            saveActiveSession();
            updatePreview();
            if (closeModalAfter) closeModal(projectModal);
            showMessage("New blank project created.", 2000);
        }

        function renderProjectList() {
            const projects = JSON.parse(localStorage.getItem(STORAGE_KEYS.PROJECTS) || '[]');
            projectList.innerHTML = '';
            if (projects.length === 0) {
                projectList.innerHTML = '<li class="project-item">No saved projects yet.</li>';
                return;
            }

            projects.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified)).forEach(p => {
                const li = document.createElement('li');
                li.className = 'project-item';
                li.innerHTML = `
                    <div class="project-item-info">
                        <span class="project-item-name">${p.name}</span>
                        <span class="project-item-date">Last saved: ${new Date(p.lastModified).toLocaleString()}</span>
                    </div>
                    <div class="project-item-actions">
                        <button class="load-btn" data-id="${p.id}" title="Load Project"><i class="fas fa-upload"></i></button>
                        <button class="delete-btn" data-id="${p.id}" title="Delete Project"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                li.querySelector('.load-btn').addEventListener('click', () => loadProject(p.id));
                li.querySelector('.delete-btn').addEventListener('click', () => deleteProject(p.id));
                projectList.appendChild(li);
            });
        }
        
        // --- Code Editor (CodeMirror 6) Setup ---
        function initializeCodeEditor() {
            const updateListener = EditorView.updateListener.of((update) => {
                if (update.docChanged) {
                    activeSession.html = update.state.doc.toString();
                    saveActiveSession();
                    debouncedUpdatePreview();
                }
            });

            const startState = EditorState.create({
                doc: activeSession.html,
                extensions: [
                    lineNumbers(),
                    html({ matchClosingTags: true, autoCloseTags: true }),
                    keymap.of([...defaultKeymap, indentWithTab]),
                    autocompletion(),
                    EditorView.theme({ "&": { fontSize: "0.95rem" } }),
                    updateListener,
                ]
            });

            codeEditor = new EditorView({
                state: startState,
                parent: document.getElementById('code-editor-container')
            });
        }

        // --- Core Functionality ---
        const googleFonts = ["Roboto", "Open Sans", "Lato", "Montserrat", "Oswald", "Source Sans Pro", "Noto Sans", "Poppins", "Raleway", "Ubuntu", "Merriweather", "Playfair Display", "Lora", "Crimson Text", "IBM Plex Sans", "Inter", "Fira Sans", "Nunito", "Quicksand", "Work Sans", "Rubik", "Bitter", "PT Sans", "Dosis", "Exo 2", "Cabin", "Titillium Web", "Josefin Sans", "Varela Round", "Lobster", "Pacifico", "Great Vibes", "Dancing Script", "Indie Flower", "Permanent Marker", "Amatic SC", "Shadows Into Light", "Bebas Neue", "Anton", "Righteous", "Alfa Slab One", "Passion One", "Ultra", "Comfortaa", "Kanit", "Prompt", "Karla", "Space Mono", "Inconsolata", "Cutive Mono", "Source Code Pro", "Fira Code"];
        
        function updatePreview() {
            try {
                iframeDoc = previewFrame.contentWindow.document;
                const fontFamiliesParam = googleFonts.map(f => `family=${encodeURIComponent(f)}`).join('&');
                const googleFontsLink = `https://fonts.googleapis.com/css2?${fontFamiliesParam}&display=swap`;
                const iframeHTML = `
                    <!DOCTYPE html><html><head>
                        <link href="${googleFontsLink}" rel="stylesheet">
                        <style>body{margin:0;padding:1rem;font-family:'Inter',sans-serif;line-height:1.6;} *{box-sizing:border-box;} img{max-width:100%;height:auto;}</style>
                    </head><body>${codeEditor.state.doc.toString()}</body></html>`;
                iframeDoc.open();
                iframeDoc.write(iframeHTML);
                iframeDoc.close();
                iframeDoc.designMode = 'on';
                iframeDoc.body.addEventListener('input', syncFromPreviewDebounced);
            } catch (error) {
                console.error('Error rendering HTML:', error);
                showMessage('Error rendering preview.', 5000);
            }
        }
        const debouncedUpdatePreview = debounce(updatePreview, 500);

        function syncFromPreview() {
            if (!iframeDoc) return;
            const newHtml = iframeDoc.body.innerHTML;
            if (newHtml !== activeSession.html) {
                activeSession.html = newHtml;
                codeEditor.dispatch({
                    changes: { from: 0, to: codeEditor.state.doc.length, insert: newHtml }
                });
                // The editor listener will handle saving and preview updates
                showMessage('Synced from preview to code.', 2000);
            }
        }
        const syncFromPreviewDebounced = debounce(syncFromPreview, 500);

        function downloadHtml() {
            const blob = new Blob([codeEditor.state.doc.toString()], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${(activeSession.name || 'untitled').replace(/\s+/g, '_')}.html`;
            document.body.appendChild(a);
a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }
        
        // --- WYSIWYG Toolbar ---
        function executeCommand(command, value = null) {
            if (!iframeDoc) return;
            previewFrame.contentWindow.focus();
            iframeDoc.execCommand(command, false, value);
            syncFromPreviewDebounced();
        }
        
        function openModal(modalEl) {
            if (iframeDoc && previewFrame.contentWindow.getSelection().rangeCount > 0) {
                currentRange = previewFrame.contentWindow.getSelection().getRangeAt(0);
            }
            modalEl.classList.add('show');
        }
        function closeModal(modalEl) {
            modalEl.classList.remove('show');
            currentRange = null;
        }

        // --- Initial Setup & Event Listeners ---
        function init() {
            // 1. Load Session or set defaults
            const savedSession = localStorage.getItem(STORAGE_KEYS.ACTIVE_SESSION);
            if (savedSession) {
                activeSession = JSON.parse(savedSession);
            }
            updateProjectNameUI();

            // 2. Initialize Code Editor
            initializeCodeEditor();

            // 3. Initialize Panels and Preview
            initializeSplitter();
            updatePreview();

            // 4. Populate Font Select
            googleFonts.sort().forEach(font => {
                const option = document.createElement('option');
                option.value = font;
                option.textContent = font;
                fontSelect.appendChild(option);
            });

            // 5. Setup Event Listeners
            renderButton.addEventListener('click', updatePreview);
            syncButton.addEventListener('click', syncFromPreview);
            downloadButton.addEventListener('click', downloadHtml);
            window.addEventListener('resize', debounce(initializeSplitter, 250));
            
            // Project management listeners
            projectsButton.addEventListener('click', () => {
                renderProjectList();
                openModal(projectModal);
            });
            saveProjectButton.addEventListener('click', saveProject);
            newProjectButton.addEventListener('click', () => createNewProject());

            // Modal listeners
            document.querySelectorAll('.modal .close-button').forEach(btn => btn.addEventListener('click', e => closeModal(e.target.closest('.modal'))));
            document.querySelectorAll('.modal').forEach(modal => modal.addEventListener('click', e => { if (e.target === modal) closeModal(modal); }));
            
            // WYSIWYG toolbar listeners
            editorToolbar.addEventListener('click', e => {
                const target = e.target.closest('.toolbar-button');
                if (target?.dataset.command) executeCommand(target.dataset.command);
            });
            document.getElementById('fontColorPicker').addEventListener('input', e => executeCommand('foreColor', e.target.value));
            document.getElementById('fontSelect').addEventListener('change', e => executeCommand('fontName', e.target.value));
            insertLinkBtn.addEventListener('click', () => openModal(linkModal));
            insertImageBtn.addEventListener('click', () => openModal(imageModal));
            document.getElementById('confirmLinkBtn').addEventListener('click', () => {
                const url = document.getElementById('linkURL').value;
                if (!url) return;
                if (currentRange) {
                    previewFrame.contentWindow.getSelection().removeAllRanges();
                    previewFrame.contentWindow.getSelection().addRange(currentRange);
                }
                executeCommand('createLink', url);
                closeModal(linkModal);
            });
            document.getElementById('confirmImageBtn').addEventListener('click', () => {
                const url = document.getElementById('imageURL').value;
                if (!url) return;
                executeCommand('insertImage', url);
                closeModal(imageModal);
            });
            clearFormatBtn.addEventListener('click', () => executeCommand('removeFormat'));
        }

        // --- Panel Resizing Logic (Split.js) ---
        let splitInstance = null;
        function initializeSplitter() {
            const isDesktop = window.innerWidth >= 1024;
            const direction = isDesktop ? 'horizontal' : 'vertical';
            appContainer.style.flexDirection = isDesktop ? 'row' : 'column';
            if (splitInstance) splitInstance.destroy();
            splitInstance = Split(['#code-panel', '#preview-panel'], {
                sizes: [50, 50],
                minSize: isDesktop ? 250 : 200,
                gutterSize: 12,
                direction: direction,
                cursor: isDesktop ? 'ew-resize' : 'ns-resize',
                onDragEnd: () => { if(codeEditor) codeEditor.requestMeasure(); } // Recalculate CM layout on resize
            });
        }
        
        // --- Start the application ---
        init();
    });
    </script>
</body>
</html>
